name: æé™å‹-AMD

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ç³»ç»Ÿåˆå§‹çŠ¶æ€
        run: |
          echo "============================================="
          echo "åˆå§‹ç³»ç»ŸçŠ¶æ€"
          echo "============================================="
          echo "å†…å­˜å’Œäº¤æ¢ç©ºé—´ï¼š"
          sudo free -h
          echo ""
          echo "å¯ç”¨å­˜å‚¨ï¼š"
          sudo df -h
          echo ""
          
      - name: åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶
        run: |
          set -euo pipefail
          
          echo "============================================="
          echo "åˆ é™¤ä¸éœ€è¦çš„è½¯ä»¶"
          echo "============================================="
          echo ""
          
          SPACE_BEFORE=$(df --output=avail -B 1 / | tail -1)
          
          remove_dir() {
            local dir="$1"
            local name="$2"
            if [[ -d "$dir" ]] || [[ -f "$dir" ]]; then
              echo -n "åˆ é™¤ $name... "
              local size_mb=$(sudo du -sm "$dir" 2>/dev/null | cut -f1 || echo "0")
              sudo rm -rf "$dir"
              echo "é‡Šæ”¾ ${size_mb} MB"
            else
              echo "è·³è¿‡ $name (æœªæ‰¾åˆ°)"
            fi
          }
          
          # æé™å‹ - åˆ é™¤æ‰€æœ‰å¯åˆ é™¤çš„è½¯ä»¶
          
          # ç¬¬ä¸€æ­¥ï¼šå¸è½½APTè½¯ä»¶åŒ…
          echo ""
          echo "æ­£åœ¨å¸è½½APTè½¯ä»¶åŒ…..."
          sudo apt-get remove -y --purge \
            microsoft-edge-stable \
            azure-cli \
            google-cloud-cli \
            google-chrome-stable \
            firefox \
            powershell \
            kubectl \
            snapd \
            'temurin-*-jdk' \
            'llvm-*-dev' \
            'openjdk-*-jre-headless' \
            'openjdk-*-jdk-headless' \
            2>/dev/null || true
          
          sudo apt-get autoremove -y 2>/dev/null || true
          echo "APTè½¯ä»¶åŒ…å¸è½½å®Œæˆ"
          echo ""
          
          # ç¬¬äºŒæ­¥ï¼šåˆ é™¤ç›®å½•ï¼ˆåŒ…æ‹¬APTæ®‹ç•™å’ŒéAPTè½¯ä»¶ï¼‰
          remove_dir "/usr/share/dotnet" ".NET SDK"
          remove_dir "/usr/local/lib/android" "Android SDK"
          remove_dir "/usr/local/.ghcup" "GHCup"
          remove_dir "/opt/hostedtoolcache" "GitHub å·¥å…·ç¼“å­˜"
          remove_dir "/usr/lib/jvm" "Java JVM"
          remove_dir "/usr/share/java" "Java å…±äº«æ–‡ä»¶"
          remove_dir "/usr/share/swift" "Swift"
          remove_dir "/usr/local/share/powershell" "PowerShell"
          remove_dir "/opt/microsoft/powershell" "PowerShell (opt)"
          remove_dir "/opt/microsoft/msedge" "Microsoft Edge"
          remove_dir "/opt/az" "Azure CLI"
          for az_dir in /usr/share/az_*; do
            if [ -d "$az_dir" ]; then
              remove_dir "$az_dir" "Azure CLI æ®‹ç•™"
            fi
          done
          remove_dir "/usr/lib/google-cloud-sdk" "Google Cloud SDK"
          remove_dir "/usr/local/aws-cli" "AWS CLI"
          remove_dir "/usr/local/aws-sam-cli" "AWS SAM CLI"
          remove_dir "/usr/local/sessionmanagerplugin" "AWS Session Manager"
          remove_dir "/usr/lib/firefox" "Firefox"
          remove_dir "/opt/google/chrome" "Google Chrome"
          remove_dir "/usr/local/share/chromium" "Chromium"
          remove_dir "/usr/local/julia1.11.7" "Julia"
          remove_dir "/usr/share/miniconda" "Miniconda"
          remove_dir "/etc/skel/.cargo" "Rust Cargo"
          remove_dir "/home/runner/.cargo" "Rust Cargo"
          remove_dir "/home/packer/.cargo" "Rust Cargo"
          remove_dir "/home/runner/.rustup" "Rustup"
          remove_dir "/home/packer/.rustup" "Rustup"
          remove_dir "/usr/local/n" "Node ç‰ˆæœ¬ç®¡ç†å™¨"
          remove_dir "/usr/lib/llvm-16" "LLVM 16"
          remove_dir "/usr/lib/llvm-17" "LLVM 17"
          remove_dir "/usr/lib/llvm-18" "LLVM 18"
          remove_dir "/usr/share/gradle-9.1.0" "Gradle"
          remove_dir "/usr/share/kotlinc" "Kotlin"
          remove_dir "/opt/pipx" "Pipx"
          remove_dir "/opt/actionarchivecache" "Action Archive Cache"
          remove_dir "/opt/runner-cache" "Runner Cache"
          remove_dir "/opt/hca" "HCA"
          remove_dir "/usr/share/man" "æ‰‹å†Œé¡µ"
          remove_dir "/usr/share/doc" "æ–‡æ¡£"
          remove_dir "/usr/local/doc" "æœ¬åœ°æ–‡æ¡£"
          remove_dir "/usr/share/locale" "å¤šè¯­è¨€æ”¯æŒ"
          remove_dir "/usr/share/fonts" "å­—ä½“æ–‡ä»¶"
          remove_dir "/usr/share/i18n" "å›½é™…åŒ–æ•°æ®"
          remove_dir "/usr/lib/snapd" "Snapd"
          remove_dir "/var/lib/snapd" "Snapd æ•°æ®"
          remove_dir "/home/linuxbrew/.linuxbrew" "Homebrew"
          remove_dir "/usr/src" "å†…æ ¸æºç "
          
          echo -n "åˆ é™¤ Docker é•œåƒ... "
          sudo docker image prune --all --force > /dev/null 2>&1
          echo "å®Œæˆ"
          
          echo -n "æœ€ç»ˆæ¸…ç†... "
          sudo apt-get clean > /dev/null 2>&1 || true
          echo "å®Œæˆ"
          
          SPACE_AFTER=$(df --output=avail -B 1 / | tail -1)
          SPACE_FREED=$((SPACE_AFTER - SPACE_BEFORE))
          SPACE_FREED_MB=$((SPACE_FREED / 1024 / 1024))
          
          echo ""
          echo "æ€»å…±é‡Šæ”¾ç©ºé—´: ${SPACE_FREED_MB} MB"
          echo ""
          
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        
      - name: æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
        run: |
          echo "============================================="
          echo "âœ… æé™å‹ä¼˜åŒ–å®Œæˆ"
          echo "============================================="
          echo ""
          echo "ğŸ“Š å­˜å‚¨çŠ¶æ€ï¼š"
          df -h | grep -E '(Filesystem|/$)'
          echo ""
          echo "ğŸ§  å†…å­˜çŠ¶æ€ï¼š"
          free -h
          echo ""
          ROOT_AVAIL=$(df -BG --output=avail / | tail -1 | tr -d 'G ')
          echo "ğŸ‰ æ ¹ç›®å½•å¯ç”¨ç©ºé—´: ${ROOT_AVAIL} GB"
          echo "============================================="
          echo ""
          
      - name: å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
        run: |
          if [ -f "start.sh" ]; then
            echo "æ­£åœ¨å¯åŠ¨åº”ç”¨..."
            bash start.sh
          else
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ° start.sh æ–‡ä»¶ï¼Œè·³è¿‡åº”ç”¨å¯åŠ¨"
          fi

